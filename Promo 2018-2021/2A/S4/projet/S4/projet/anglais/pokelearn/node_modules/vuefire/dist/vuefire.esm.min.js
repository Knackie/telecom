/*!
  * vuefire v2.2.0
  * (c) 2019 Eduardo San Martin Morote
  * @license MIT
  */
function e(e,t,n){var r=(""+t).split("."),i=r.pop(),o=r.reduce(function(e,t){return e[t]},e);return Array.isArray(o)?o.splice(Number(i),1,n):o[i]=n}function t(e){return e&&"object"==typeof e}function n(e,t){for(var n=0;n<e.length;n++)if(e[n][".key"]===t)return n;return-1}var r={reset:!0,serialize:function(e){var n=e.val(),r=t(n)?n:Object.defineProperty({},".value",{value:n});return Object.defineProperty(r,".key",{value:e.key}),r},wait:!1};function i(e,n,r,o){void 0===n&&(n={}),void 0===r&&(r=""),void 0===o&&(o=[{},{}]),n=n||{};var s=o[0],a=o[1],f=Object.getOwnPropertyDescriptor(e,"id");f&&!f.enumerable&&Object.defineProperty(s,"id",f);var c=function(o){var f,c=e[o];if((f=c)&&f.onSnapshot)s[o]=n[o]||c.path,a[r+o]=c;else if(Array.isArray(c)){s[o]=Array(c.length);var u=(n[o]||[]).filter(function(e){return-1!==c.indexOf(e)});i(c,u,r+o+".",[s[o],a])}else null==c||c instanceof Date||function(e){return e.toDate}(c)||c.longitude&&c.latitude?s[o]=c:t(c)?(s[o]={},i(c,n[o],r+o+".",[s[o],a])):s[o]=c};for(var u in e)c(u);return o}var o={maxRefDepth:2,reset:!0,serialize:function(e){return Object.defineProperty(e.data(),"id",{value:e.id})},wait:!1};function s(e){for(var t in e)e[t].unsub()}function a(e,t){var n=e.snapshot,r=e.target,o=e.path,s=e.subs,a=e.ops,f=e.depth,u=e.resolve,l=i(n,function(e,t){return t.split(".").reduce(function(e,t){return e[t]},e)}(r,o)),d=l[0],v=l[1];a.set(r,o,d),c({subs:s,refs:v,target:r,path:o,ops:a,depth:f,resolve:u},t)}function f(e,t){var n=e.ref,r=e.target,i=e.path,o=e.depth,f=e.resolve,c=e.ops,u=Object.create(null),l=n.onSnapshot(function(e){e.exists?a({snapshot:t.serialize(e),target:r,path:i,ops:c,subs:u,depth:o,resolve:f},t):(c.set(r,i,null),f(i))});return function(){l(),s(u)}}function c(e,t){var n=e.subs,r=e.refs,i=e.target,o=e.path,s=e.depth,a=e.ops,c=e.resolve,u=Object.keys(r);if(Object.keys(n).filter(function(e){return u.indexOf(e)<0}).forEach(function(e){n[e].unsub(),delete n[e]}),!u.length||++s>t.maxRefDepth)return c(o);var l=0,d=u.length,v=Object.create(null);function p(e){e in v&&++l>=d&&c(o)}u.forEach(function(e){var c=n[e],u=r[e],l=o+"."+e;if(v[l]=!0,c){if(c.path===u.path)return;c.unsub()}n[e]={unsub:f({ref:u,target:i,path:l,depth:s,ops:a,resolve:p.bind(null,l)},t),path:u.path}})}var u={set:function(t,n,r){return e(t,n,r)},add:function(e,t,n){return e.splice(t,0,n)},remove:function(e,t){return e.splice(t,1)}};function l(e,t,i,o){return new Promise(function(s,a){var f;f=Array.isArray(e[t])?function(e,t){var i=e.vm,o=e.key,s=e.collection,a=e.resolve,f=e.reject,c=e.ops;void 0===t&&(t=r);var u=Object.assign({},r,t),l=u.wait?[]:c.set(i,o,[]),d=s.on("child_added",function(e,t){var r=t?n(l,t)+1:0;c.add(l,r,u.serialize(e))},f),v=s.on("child_removed",function(e){c.remove(l,n(l,e.key))},f),p=s.on("child_changed",function(e){c.set(l,n(l,e.key),u.serialize(e))},f),b=s.on("child_moved",function(e,t){var r=n(l,e.key),i=c.remove(l,r)[0],o=t?n(l,t)+1:0;c.add(l,o,i)},f);return s.once("value",function(e){u.wait&&c.set(i,o,l),a(e)}),function(e){if(s.off("child_added",d),s.off("child_changed",p),s.off("child_removed",v),s.off("child_moved",b),!1!==e){var t="function"==typeof e?e():[];c.set(i,o,t)}}}({vm:e,key:t,collection:i,resolve:s,reject:a,ops:u},o):function(e,t){var n=e.vm,i=e.key,o=e.document,s=e.resolve,a=e.reject,f=e.ops;void 0===t&&(t=r);var c=Object.assign({},r,t),u=o.on("value",function(e){f.set(n,i,c.serialize(e))},a);return o.once("value",s),function(e){if(o.off("value",u),!1!==e){var t="function"==typeof e?e():null;f.set(n,i,t)}}}({vm:e,key:t,document:i,resolve:s,reject:a,ops:u},o),e._firebaseUnbinds[t]=f})}var d={bindName:"$rtdbBind",unbindName:"$rtdbUnbind",serialize:r.serialize,reset:r.reset,wait:r.wait},v=function(e,t){void 0===t&&(t=d);var n=e.config.optionMergeStrategies;n.firebase=n.provide;var r=Object.assign({},d,t),i=r.bindName,o=r.unbindName;e.prototype[o]=function(e,t){!function(e,t,n){e._firebaseUnbinds[t](n),delete e._firebaseSources[t],delete e._firebaseUnbinds[t]}(this,e,t)},e.prototype[i]=function(e,t,n){var i=Object.assign({},r,n);this._firebaseUnbinds[e]&&this[o](e,i.wait?"function"==typeof i.reset&&i.reset:i.reset);var s=l(this,e,t,i);return this._firebaseSources[e]=t,this.$firebaseRefs[e]=t.ref,s},e.mixin({beforeCreate:function(){this.$firebaseRefs=Object.create(null),this._firebaseSources=Object.create(null),this._firebaseUnbinds=Object.create(null)},created:function(){var e=this.$options.firebase;if("function"==typeof e&&(e=e.call(this)),e)for(var t in e)this[i](t,e[t],r)},beforeDestroy:function(){for(var e in this._firebaseUnbinds)this._firebaseUnbinds[e]();this._firebaseSources=null,this._firebaseUnbinds=null,this.$firebaseRefs=null}})},p={set:function(t,n,r){return e(t,n,r)},add:function(e,t,n){return e.splice(t,0,n)},remove:function(e,t){return e.splice(t,1)}};function b(e,t,n,r,f){return new Promise(function(u,l){var d;d="where"in n?function(e,t){var n=e.vm,r=e.key,a=e.collection,f=e.ops,u=e.resolve,l=e.reject;void 0===t&&(t=o);var d,v=Object.assign({},o,t),p=v.wait?[]:f.set(n,r,[]),b=u,h=[],y={added:function(e){var t=e.newIndex,n=e.doc;h.splice(t,0,Object.create(null));var r=h[t],o=i(v.serialize(n)),s=o[0],a=o[1];f.add(p,t,s),c({refs:a,subs:r,target:p,path:t,depth:0,ops:f,resolve:u.bind(null,n)},v)},modified:function(e){var t=e.oldIndex,n=e.newIndex,r=e.doc,o=h.splice(t,1)[0];h.splice(n,0,o);var s=f.remove(p,t)[0],a=i(v.serialize(r),s),l=a[0],d=a[1];f.add(p,n,l),c({refs:d,subs:o,ops:f,target:p,path:n,depth:0,resolve:u},v)},removed:function(e){var t=e.oldIndex;f.remove(p,t),s(h.splice(t,1)[0])}},m=a.onSnapshot(function(e){var t="function"==typeof e.docChanges?e.docChanges():e.docChanges;if(!d&&t.length){d=!0;for(var i=0,o=t.length,s=Object.create(null),a=0;a<o;a++)s[t[a].doc.id]=!0;u=function(e){e.id in s&&++i>=o&&(v.wait&&f.set(n,r,p),b(n[r]),u=function(){})}}t.forEach(function(e){y[e.type](e)}),t.length||(v.wait&&f.set(n,r,p),u())},l);return function(e){if(m(),!1!==e){var t="function"==typeof e?e():[];f.set(n,r,t)}h.forEach(s)}}({vm:e,key:t,ops:r,collection:n,resolve:u,reject:l},f):function(e,t){var n=e.vm,r=e.key,i=e.document,f=e.resolve,c=e.reject,u=e.ops;void 0===t&&(t=o);var l,d,v,p=Object.assign({},o,t),b=Object.create(null);l=f,d=function(){return n[r]},v=!1,f=function(){if(!v)return v=!0,l(d())};var h=i.onSnapshot(function(e){e.exists?a({snapshot:p.serialize(e),target:n,path:r,subs:b,ops:u,depth:0,resolve:f},p):f()},c);return function(e){if(h(),!1!==e){var t="function"==typeof e?e():null;u.set(n,r,t)}s(b)}}({vm:e,key:t,ops:r,document:n,resolve:u,reject:l},f),e._firestoreUnbinds[t]=d})}var h={bindName:"$bind",unbindName:"$unbind",serialize:o.serialize,reset:o.reset,wait:o.wait},y=function(e,t){void 0===t&&(t=h);var n=e.config.optionMergeStrategies;n.firestore=n.provide;var r=Object.assign({},h,t),i=r.bindName,o=r.unbindName;e.prototype[o]=function(e,t){this._firestoreUnbinds[e](t),delete this._firestoreUnbinds[e],delete this.$firestoreRefs[e]},e.prototype[i]=function(e,t,n){var i=Object.assign({},r,n);this._firestoreUnbinds[e]&&this[o](e,i.wait?"function"==typeof i.reset&&i.reset:i.reset);var s=b(this,e,t,p,i);return this.$firestoreRefs[e]=t,s},e.mixin({beforeCreate:function(){this._firestoreUnbinds=Object.create(null),this.$firestoreRefs=Object.create(null)},created:function(){var e=this.$options.firestore,t="function"==typeof e?e.call(this):e;if(t)for(var n in t)this[i](n,t[n],r)},beforeDestroy:function(){for(var e in this._firestoreUnbinds)this._firestoreUnbinds[e]();this._firestoreUnbinds=null,this.$firestoreRefs=null}})};export{y as firestorePlugin,v as rtdbPlugin};
